<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Arbitrage Scanner</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{background:#08080c;color:#ccc;font-family:'Consolas','Monaco','Courier New',monospace;display:flex;flex-direction:column;height:100vh}

.hdr{background:#0a0a10;border-bottom:1px solid #151520;padding:10px 14px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;flex-shrink:0}
.title{font-size:14px;font-weight:800;letter-spacing:1px;background:linear-gradient(90deg,#7ec8e3,#00ff88);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.badges{display:flex;align-items:center;gap:8px;flex-wrap:wrap;font-size:10px;font-weight:600}
.bg{color:#00ff88}.by{color:#e8e800}.bm{color:#ff00ff}.bc{color:#7ec8e3}

.ctrl{display:flex;align-items:center;gap:10px;padding:6px 14px;background:#090910;border-bottom:1px solid #151520;flex-wrap:wrap;flex-shrink:0}
.lbl{color:#333;font-size:9px;font-weight:700;letter-spacing:1px;margin-right:2px}
.tg{display:inline-flex;border-radius:4px;overflow:hidden;border:1px solid #1a1a28}
.tb{padding:3px 10px;border:none;background:#0a0a12;color:#444;font-size:10px;font-weight:600;cursor:pointer;font-family:inherit}
.tb:hover{color:#888}.tb.ta{background:#7ec8e3;color:#0a0a0f}
.mbtn{padding:5px 16px;border:none;border-radius:4px;font-size:11px;font-weight:800;cursor:pointer;font-family:inherit;letter-spacing:.5px}
.go{background:#00ff88;color:#0a0a0f}.stp{background:#ff4444;color:#fff}
.mbtn:hover{filter:brightness(1.15)}
.sb{padding:3px 8px;border:1px solid #1a1a28;border-radius:3px;background:#0c0c14;color:#666;font-size:10px;font-weight:600;cursor:pointer;font-family:inherit}
.sb:hover{border-color:#333;color:#999}
.csb{padding:2px 6px;border:1px solid #1a1a28;border-radius:3px;font-size:9px;font-weight:700;cursor:pointer;font-family:inherit;background:#0a0a12;color:#444}

.chip-row{display:flex;gap:3px;padding:5px 14px;background:#090910;border-bottom:1px solid #151520;flex-wrap:wrap;flex-shrink:0}
.chip{padding:2px 7px;border:1px solid #151520;border-radius:10px;font-size:9px;font-weight:600;cursor:pointer;font-family:inherit;background:#08080c;color:#2a2a3e}
.chip:hover{border-color:#333}.chip.on{background:#111118;border-color:#222;color:#bbb}
.chip.hot{border-color:#00ff8830;color:#00ff88;background:#0a140f}

.ex-row{display:flex;gap:3px;padding:5px 14px;background:#08080c;border-bottom:1px solid #151520;flex-wrap:wrap;flex-shrink:0}
.exc{display:inline-flex;align-items:center;gap:4px;padding:3px 7px;border:1px solid #111118;border-radius:3px;cursor:pointer;font-size:9px;font-weight:700}
.exc:hover{border-color:#222}.exc.off{opacity:.2}
.dot{width:6px;height:6px;border-radius:50%;display:inline-block}

.status-bar{padding:5px 14px;background:#0a0a10;border-bottom:1px solid #151520;font-size:10px;flex-shrink:0;max-height:50px;overflow-y:auto}
.smsg.ok{color:#00ff88}.smsg.err{color:#ff4444}.smsg.warn{color:#e8e800}.smsg.info{color:#7ec8e3}

.table-wrap{flex:1;overflow-y:auto;min-height:0}
table.mt{width:100%;border-collapse:collapse}
.mt thead th{padding:7px 12px;font-size:10px;font-weight:700;color:#444;text-transform:uppercase;letter-spacing:.7px;border-bottom:1px solid #151520;background:#0a0a10;position:sticky;top:0;z-index:2}
.mrow{cursor:pointer;border-bottom:1px solid #0c0c14}
.mrow:hover{background:#0e0e18}
.mrow.exp{background:#0c0c16}
.mrow.profit{background:#080f0c}
.mrow.profit:hover{background:#0a140f}
.mrow td{padding:9px 12px;font-size:13px;font-variant-numeric:tabular-nums}
.tk{font-weight:800;color:#7ec8e3;font-size:14px}
.tksub{color:#2a2a3e;font-size:10px;margin-left:2px}
.arrow{color:#333;font-size:10px;margin-left:5px;display:inline-block;transition:transform .2s ease}
.arrow.open{transform:rotate(180deg);color:#7ec8e3}

/* ── dropdown detail ── */
.dd-wrap{max-height:0;overflow:hidden;transition:max-height .35s cubic-bezier(.4,0,.2,1)}
.dd-wrap.open{max-height:500px}
.dd-inner{background:#070710;border-bottom:2px solid #151520}
.dd-hdr{display:flex;justify-content:space-between;align-items:center;padding:6px 14px;font-size:10px;color:#555;border-bottom:1px solid #0f0f18;flex-wrap:wrap;gap:6px}
table.dt{width:100%;border-collapse:collapse}
.dt th{padding:4px 8px;text-align:right;font-size:9px;font-weight:700;color:#333;text-transform:uppercase;letter-spacing:.4px;border-bottom:1px solid #0f0f18;background:#060610}
.dt td{padding:5px 8px;text-align:right;font-size:11px;font-variant-numeric:tabular-nums}
.dt-row{border-bottom:1px solid #0a0a12}
.dt-row:hover{background:#0d0d18}
.tag{font-size:7px;font-weight:800;padding:1px 4px;border-radius:2px;letter-spacing:.4px;margin-left:3px}
.tag.buy{background:#ff6b6b22;color:#ff6b6b;border:1px solid #ff6b6b33}
.tag.sell{background:#00ff8822;color:#00ff88;border:1px solid #00ff8833}
.fr-p{color:#4ecdc4}.fr-n{color:#ff6b6b}.fr-z{color:#333}

.foot{display:flex;justify-content:space-between;padding:4px 14px;background:#0a0a10;border-top:1px solid #151520;font-size:9px;color:#1a1a28;flex-shrink:0}

.ov{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:1000}
.ov.show{display:flex}
.modal{background:#0c0c18;border:1px solid #1a1a28;border-radius:8px;padding:16px;min-width:280px;max-width:440px;max-height:80vh;overflow-y:auto}
.m-ta{width:100%;background:#07070c;color:#bbb;border:1px solid #1a1a28;border-radius:4px;padding:8px;font-family:inherit;font-size:11px;resize:vertical;outline:none}

::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:#08080c}
::-webkit-scrollbar-thumb{background:#1a1a28;border-radius:2px}
</style>
</head>
<body>

<div class="hdr">
  <div style="display:flex;align-items:center;gap:10px;flex:1;flex-wrap:wrap">
    <span class="title">◆ Arbitrage Scanner</span>
    <div class="badges" id="badges"></div>
  </div>
  <div style="display:flex;gap:5px;flex-shrink:0">
    <button class="mbtn go" id="startBtn">▶ Start</button>
    <button class="sb" id="pairsBtn">Pairs</button>
    <button class="sb" id="cfgBtn">⚙</button>
  </div>
</div>

<div class="ctrl">
  <div style="display:flex;align-items:center;gap:4px">
    <span class="lbl">MODE</span>
    <div class="tg" id="modeGrp"></div>
  </div>
  <div style="display:flex;align-items:center;gap:4px">
    <span class="lbl">SORT</span>
    <div class="tg" id="sortGrp"></div>
  </div>
  <div style="display:flex;gap:3px;margin-left:auto">
    <button class="csb" id="allBtn">All</button>
    <button class="csb" id="noneBtn">None</button>
  </div>
</div>

<div class="chip-row" id="chipRow"></div>
<div class="ex-row" id="exRow"></div>
<div class="status-bar" id="statusBar" style="display:none"></div>

<div class="table-wrap" id="tableWrap">
  <table class="mt">
    <thead><tr>
      <th style="text-align:left;width:100px">Ticker</th>
      <th style="text-align:left">bestルート</th>
      <th style="text-align:right;width:260px">値段</th>
      <th style="text-align:right;width:100px">乖離度</th>
    </tr></thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div class="foot">
  <span>Arbitrage Scanner v4</span>
  <span id="footSt">Ready</span>
</div>

<div class="ov" id="editOv">
  <div class="modal" onclick="event.stopPropagation()">
    <h3 style="color:#7ec8e3;margin:0 0 10px;font-size:14px">ペアリスト編集</h3>
    <p style="color:#555;font-size:10px;margin-bottom:6px">1行に1ティッカー（例: BTC）</p>
    <textarea id="editTa" class="m-ta" rows="14"></textarea>
    <div style="display:flex;gap:6px;margin-top:10px">
      <button class="mbtn go" id="editSaveBtn">保存</button>
      <button class="sb" id="editCancelBtn">キャンセル</button>
    </div>
  </div>
</div>
<div class="ov" id="cfgOv">
  <div class="modal" onclick="event.stopPropagation()">
    <h3 style="color:#7ec8e3;margin:0 0 12px;font-size:14px">設定</h3>
    <div id="cfgList" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px"></div>
    <button class="sb" id="cfgCloseBtn">閉じる</button>
  </div>
</div>

<script>
(function(){
"use strict";

/* ═══════════════ STATE ═══════════════ */
var EX={binance:{label:"Binance",c:"#F0B90B"},okx:{label:"OKX",c:"#FFFFFF"},bybit:{label:"Bybit",c:"#F7A600"},bitget:{label:"Bitget",c:"#00E0AA"},mexc:{label:"MEXC",c:"#2EBD85"},gate:{label:"Gate",c:"#2354E6"},hyperliquid:{label:"Hyperliquid",c:"#82FFB5"},aster:{label:"Aster",c:"#FF6B6B"}};
var EX_IDS=Object.keys(EX);
var FEE={futures:0.0007,spot:0.001};

var allPairs=["BTC","ETH","SOL","BNB","XRP","DOGE","ADA","AVAX","LINK","ARB","NEAR","OP","APT","SUI","PEPE","WIF","TIA","INJ","SEI","FET"];
var watchPairs=allPairs.slice(0,10);
var enabled={};EX_IDS.forEach(function(k){enabled[k]=true;});
var mode="futures", sortKey="spread", monitoring=false;
var bbo={}, exStatus={}, statusMsgs=[], cnt={}, expanded=null;

// Funding rates: fr[pair][exId] = {rate, predicted, nextTime}
var fundingRates={};
var frBusy=false, frLast=0;

var sockets={},reconTimers={},pingTimers={},wsActive=false,wsPairs=[],wsMode="futures";

function prec(p){return p>=10000?2:p>=100?4:p>=1?5:8;}
function fz(n){if(!n||isNaN(n))return"—";return n>=1000?n.toFixed(1):n.toFixed(4);}
function stamp(){var d=new Date();return d.toLocaleTimeString("en-GB",{hour12:false})+"."+String(d.getMilliseconds()).padStart(3,"0");}
function addStatus(msg,lv){statusMsgs.push({msg:msg,lv:lv||"info",t:stamp()});if(statusMsgs.length>30)statusMsgs=statusMsgs.slice(-20);}

/* ═══════════════ FUNDING RATE FETCHER ═══════════════ */
function fetchAllFR(){
  if(mode!=="futures"||!monitoring||frBusy)return;
  frBusy=true; frLast=Date.now();
  addStatus("Fetching funding rates...","info");
  var jobs=[];

  // ── Binance: batch
  jobs.push(fetch("https://fapi.binance.com/fapi/v1/premiumIndex").then(function(r){return r.json();}).then(function(arr){
    if(!Array.isArray(arr))return;
    arr.forEach(function(d){
      var p=(d.symbol||"").replace(/USDT$/i,"");
      if(watchPairs.indexOf(p)<0)return;
      if(!fundingRates[p])fundingRates[p]={};
      fundingRates[p].binance={rate:parseFloat(d.lastFundingRate)*100, nextTime:parseInt(d.nextFundingTime), mark:parseFloat(d.markPrice), index:parseFloat(d.indexPrice)};
    });
  }).catch(function(){}));

  // ── Bybit: batch
  jobs.push(fetch("https://api.bybit.com/v5/market/tickers?category=linear").then(function(r){return r.json();}).then(function(data){
    if(!data.result||!data.result.list)return;
    data.result.list.forEach(function(d){
      var p=(d.symbol||"").replace(/USDT$/i,"");
      if(watchPairs.indexOf(p)<0)return;
      if(!fundingRates[p])fundingRates[p]={};
      fundingRates[p].bybit={rate:parseFloat(d.fundingRate)*100, nextTime:parseInt(d.nextFundingTime), mark:parseFloat(d.markPrice), index:parseFloat(d.indexPrice)};
    });
  }).catch(function(){}));

  // ── OKX: per pair
  watchPairs.forEach(function(pair){
    jobs.push(fetch("https://www.okx.com/api/v5/public/funding-rate?instId="+pair+"-USDT-SWAP").then(function(r){return r.json();}).then(function(data){
      if(!data.data||!data.data[0])return;
      var d=data.data[0];
      if(!fundingRates[pair])fundingRates[pair]={};
      fundingRates[pair].okx={rate:parseFloat(d.fundingRate)*100, nextTime:parseInt(d.nextFundingTime), predicted:d.nextFundingRate?parseFloat(d.nextFundingRate)*100:null};
    }).catch(function(){}));
  });

  // ── Bitget: batch
  jobs.push(fetch("https://api.bitget.com/api/v2/mix/market/tickers?productType=USDT-FUTURES").then(function(r){return r.json();}).then(function(data){
    if(!data.data||!Array.isArray(data.data))return;
    data.data.forEach(function(d){
      var p=(d.symbol||"").replace(/USDT$/i,"");
      if(watchPairs.indexOf(p)<0)return;
      if(!fundingRates[p])fundingRates[p]={};
      fundingRates[p].bitget={rate:parseFloat(d.fundingRate)*100};
    });
  }).catch(function(){}));

  // ── MEXC: batch
  jobs.push(fetch("https://contract.mexc.com/api/v1/contract/ticker").then(function(r){return r.json();}).then(function(data){
    if(!data.data||!Array.isArray(data.data))return;
    data.data.forEach(function(d){
      var p=(d.symbol||"").replace(/_?USDT$/i,"").toUpperCase();
      if(watchPairs.indexOf(p)<0)return;
      if(!fundingRates[p])fundingRates[p]={};
      fundingRates[p].mexc={rate:parseFloat(d.fundingRate)*100, nextTime:parseInt(d.nextSettleTime)};
    });
  }).catch(function(){}));

  // ── Gate: batch
  jobs.push(fetch("https://api.gateio.ws/api/v4/futures/usdt/contracts").then(function(r){return r.json();}).then(function(arr){
    if(!Array.isArray(arr))return;
    arr.forEach(function(d){
      var p=(d.name||"").replace(/_?USDT$/i,"").toUpperCase();
      if(watchPairs.indexOf(p)<0)return;
      if(!fundingRates[p])fundingRates[p]={};
      fundingRates[p].gate={rate:parseFloat(d.funding_rate_indicative)*100, nextTime:parseInt(d.funding_next_apply)*1000};
    });
  }).catch(function(){}));

  // ── Hyperliquid: batch
  jobs.push(fetch("https://api.hyperliquid.xyz/info",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"metaAndAssetCtxs"})}).then(function(r){return r.json();}).then(function(data){
    if(!Array.isArray(data)||data.length<2)return;
    var meta=data[0],ctxs=data[1];
    if(!meta.universe||!Array.isArray(ctxs))return;
    meta.universe.forEach(function(u,i){
      var p=(u.name||"").toUpperCase();
      if(watchPairs.indexOf(p)<0)return;
      var c=ctxs[i]; if(!c)return;
      if(!fundingRates[p])fundingRates[p]={};
      fundingRates[p].hyperliquid={rate:parseFloat(c.funding)*100, mark:parseFloat(c.markPx), premium:parseFloat(c.premium)*100};
    });
  }).catch(function(){}));

  Promise.all(jobs).then(function(){frBusy=false;addStatus("FR updated ("+Object.keys(fundingRates).length+" pairs)","ok");}).catch(function(){frBusy=false;});
}

/* ═══════════════ BBO / WS ═══════════════ */
function handleBBO(exId,pair,d){var p=pair.toUpperCase();if(!bbo[p])bbo[p]={};bbo[p][exId]={bid:d.bid,ask:d.ask,bidSz:d.bidSz||0,askSz:d.askSz||0,mid:(d.bid+d.ask)/2,ts:Date.now()};cnt[p+":"+exId]=(cnt[p+":"+exId]||0)+1;}
function schedRecon(id){if(!wsActive||!enabled[id])return;reconTimers[id]=setTimeout(function(){if(wsActive&&enabled[id])connEx(id);},3000);}
function handleClose(id){if(pingTimers[id]){clearInterval(pingTimers[id]);delete pingTimers[id];}if(wsActive&&enabled[id]){exStatus[id]="reconnecting";schedRecon(id);}}

function wsStart(pairs,m,en){
  wsStop();wsActive=true;wsPairs=pairs.map(function(p){return p.toUpperCase();});wsMode=m;
  addStatus("Starting "+wsPairs.length+" pairs ["+m+"]","info");
  EX_IDS.forEach(function(id){if(en[id])connEx(id);});
  if(m==="futures"){fundingRates={};setTimeout(fetchAllFR,800);}
}
function wsStop(){wsActive=false;Object.keys(sockets).forEach(function(k){try{sockets[k].close();}catch(e){}});sockets={};Object.values(reconTimers).forEach(clearTimeout);reconTimers={};Object.values(pingTimers).forEach(clearInterval);pingTimers={};}
function connEx(id){exStatus[id]="connecting";try{CONN[id]();}catch(e){exStatus[id]="error";addStatus(EX[id].label+" ERR: "+e.message,"err");}}

var CONN={};
CONN.binance=function(){var ss=wsPairs.map(function(p){return p.toLowerCase()+"usdt@bookTicker";}).join("/");var h=wsMode==="futures"?"wss://fstream.binance.com":"wss://stream.binance.com:9443";var w=new WebSocket(h+"/stream?streams="+ss);sockets.binance=w;w.onopen=function(){exStatus.binance="active";addStatus("Binance OK","ok");};w.onmessage=function(e){try{var m=JSON.parse(e.data),d=m.data||m,p=(d.s||"").replace(/USDT$/i,"");if(p&&+d.b>0&&+d.a>0)handleBBO("binance",p,{bid:+d.b,ask:+d.a,bidSz:+d.B||0,askSz:+d.A||0});}catch(x){}};w.onerror=function(){exStatus.binance="error";};w.onclose=function(){handleClose("binance");};};

CONN.bybit=function(){var url=wsMode==="futures"?"wss://stream.bybit.com/v5/public/linear":"wss://stream.bybit.com/v5/public/spot";var w=new WebSocket(url);sockets.bybit=w;w.onopen=function(){w.send(JSON.stringify({op:"subscribe",args:wsPairs.map(function(p){return"tickers."+p+"USDT";})}));exStatus.bybit="active";addStatus("Bybit OK","ok");pingTimers.bybit=setInterval(function(){try{w.send(JSON.stringify({op:"ping"}));}catch(x){}},20000);};w.onmessage=function(e){try{var m=JSON.parse(e.data);if(!m.topic||!m.data)return;var p=m.topic.replace("tickers.","").replace(/USDT$/i,""),d=m.data,b=+d.bid1Price,a=+d.ask1Price;if(b>0&&a>0)handleBBO("bybit",p,{bid:b,ask:a,bidSz:+d.bid1Size||0,askSz:+d.ask1Size||0});}catch(x){}};w.onerror=function(){exStatus.bybit="error";};w.onclose=function(){handleClose("bybit");};};

CONN.okx=function(){var w=new WebSocket("wss://ws.okx.com:8443/ws/v5/public");sockets.okx=w;w.onopen=function(){var sfx=wsMode==="futures"?"-USDT-SWAP":"-USDT";w.send(JSON.stringify({op:"subscribe",args:wsPairs.map(function(p){return{channel:"bbo-tbt",instId:p+sfx};})}));exStatus.okx="active";addStatus("OKX OK","ok");};w.onmessage=function(e){try{var m=JSON.parse(e.data);if(!m.data||!m.arg)return;var p=(m.arg.instId||"").split("-")[0],d=m.data[0],b=+d.bidPx,a=+d.askPx;if(b>0&&a>0)handleBBO("okx",p,{bid:b,ask:a,bidSz:+d.bidSz||0,askSz:+d.askSz||0});}catch(x){}};w.onerror=function(){exStatus.okx="error";};w.onclose=function(){handleClose("okx");};};

CONN.bitget=function(){var w=new WebSocket("wss://ws.bitget.com/v2/ws/public");sockets.bitget=w;w.onopen=function(){var t=wsMode==="futures"?"USDT-FUTURES":"SPOT";w.send(JSON.stringify({op:"subscribe",args:wsPairs.map(function(p){return{instType:t,channel:"ticker",instId:p+"USDT"};})}));exStatus.bitget="active";addStatus("Bitget OK","ok");pingTimers.bitget=setInterval(function(){try{w.send("ping");}catch(x){}},25000);};w.onmessage=function(e){try{if(e.data==="pong")return;var m=JSON.parse(e.data);if(!m.data||!Array.isArray(m.data))return;var d=m.data[0];if(!d)return;var p=(d.instId||"").replace(/USDT$/i,""),b=+(d.bidPr||d.bestBid||0),a=+(d.askPr||d.bestAsk||0);if(b>0&&a>0)handleBBO("bitget",p,{bid:b,ask:a,bidSz:+d.bidSz||0,askSz:+d.askSz||0});}catch(x){}};w.onerror=function(){exStatus.bitget="error";};w.onclose=function(){handleClose("bitget");};};

CONN.mexc=function(){var url=wsMode==="futures"?"wss://contract.mexc.com/edge":"wss://wbs.mexc.com/ws";var w=new WebSocket(url);sockets.mexc=w;w.onopen=function(){if(wsMode==="futures"){wsPairs.forEach(function(p){w.send(JSON.stringify({method:"sub.ticker",param:{symbol:p+"USDT"}}));});}else{w.send(JSON.stringify({method:"SUBSCRIPTION",params:wsPairs.map(function(p){return"spot@public.bookTicker.v3.api@"+p+"USDT";})}));}exStatus.mexc="active";addStatus("MEXC OK","ok");pingTimers.mexc=setInterval(function(){try{w.send(wsMode==="futures"?JSON.stringify({method:"ping"}):"ping");}catch(x){}},20000);};w.onmessage=function(e){try{var m=JSON.parse(e.data);if(wsMode==="spot"){var p2=(m.s||"").replace(/USDT$/i,""),dd=m.d||m,b=+(dd.b||dd.bidPrice||0),a=+(dd.a||dd.askPrice||0);if(b>0&&a>0&&p2)handleBBO("mexc",p2,{bid:b,ask:a,bidSz:+(dd.B||0),askSz:+(dd.A||0)});}else if(m.data){var d2=m.data,p3=(d2.symbol||"").replace(/_?USDT$/i,""),b2=+(d2.bid1||0),a2=+(d2.ask1||0);if(b2>0&&a2>0&&p3)handleBBO("mexc",p3,{bid:b2,ask:a2,bidSz:0,askSz:0});}}catch(x){}};w.onerror=function(){exStatus.mexc="error";};w.onclose=function(){handleClose("mexc");};};

CONN.gate=function(){var url=wsMode==="futures"?"wss://fx-ws.gateio.ws/v4/ws/usdt":"wss://api.gateio.ws/ws/v4/";var w=new WebSocket(url);sockets.gate=w;w.onopen=function(){var ch=wsMode==="futures"?"futures.book_ticker":"spot.book_ticker";w.send(JSON.stringify({time:Math.floor(Date.now()/1000),channel:ch,event:"subscribe",payload:wsPairs.map(function(p){return p+"_USDT";})}));exStatus.gate="active";addStatus("Gate OK","ok");};w.onmessage=function(e){try{var m=JSON.parse(e.data),d=m.result;if(!d)return;var p=(d.s||d.contract||"").replace(/_?USDT$/i,"").toUpperCase(),b=+(d.b||d.best_bid||0),a=+(d.a||d.best_ask||0);if(b>0&&a>0&&p)handleBBO("gate",p,{bid:b,ask:a,bidSz:+(d.B||d.best_bid_amount||0),askSz:+(d.A||d.best_ask_amount||0)});}catch(x){}};w.onerror=function(){exStatus.gate="error";};w.onclose=function(){handleClose("gate");};};

CONN.hyperliquid=function(){var w=new WebSocket("wss://api.hyperliquid.xyz/ws");sockets.hyperliquid=w;w.onopen=function(){wsPairs.forEach(function(p){w.send(JSON.stringify({method:"subscribe",subscription:{type:"l2Book",coin:p}}));});exStatus.hyperliquid="active";addStatus("HL OK","ok");};w.onmessage=function(e){try{var m=JSON.parse(e.data);if(m.channel!=="l2Book"||!m.data||!m.data.levels)return;var p=(m.data.coin||"").toUpperCase(),bids=m.data.levels[0]||[],asks=m.data.levels[1]||[];if(bids.length&&asks.length){var b=+bids[0].px,a=+asks[0].px;if(b>0&&a>0)handleBBO("hyperliquid",p,{bid:b,ask:a,bidSz:+bids[0].sz||0,askSz:+asks[0].sz||0});}}catch(x){}};w.onerror=function(){exStatus.hyperliquid="error";};w.onclose=function(){handleClose("hyperliquid");};};

CONN.aster=function(){var ss=wsPairs.map(function(p){return p.toLowerCase()+"usdt@bookTicker";}).join("/");var h=wsMode==="futures"?"wss://fstream.asterdex.com":"wss://sstream.asterdex.com";var w=new WebSocket(h+"/stream?streams="+ss);sockets.aster=w;w.onopen=function(){exStatus.aster="active";addStatus("Aster OK","ok");};w.onmessage=function(e){try{var pl=JSON.parse(e.data),d=pl.data||pl,p=(d.s||"").replace(/USDT$/i,"").toUpperCase(),b=+(d.b||d.bidPrice||0),a=+(d.a||d.askPrice||0);if(b>0&&a>0&&p)handleBBO("aster",p,{bid:b,ask:a,bidSz:+(d.B||0),askSz:+(d.A||0)});}catch(x){}};w.onerror=function(){exStatus.aster="error";};w.onclose=function(){handleClose("aster");};};

/* ═══════════════ ARB CALC ═══════════════ */
function calcArb(pb){
  var ent=[];Object.keys(pb).forEach(function(ex){var d=pb[ex];if(d&&d.bid>0&&d.ask>0)ent.push({ex:ex,bid:d.bid,ask:d.ask,bidSz:d.bidSz,askSz:d.askSz});});
  if(ent.length<2)return null;
  var bB=null,bA=null;
  ent.forEach(function(e){if(!bB||e.bid>bB.p)bB={ex:e.ex,p:e.bid,sz:e.bidSz};if(!bA||e.ask<bA.p)bA={ex:e.ex,p:e.ask,sz:e.askSz};});
  if(bB.ex===bA.ex){var bB2=null,bA2=null;ent.forEach(function(e){if(e.ex!==bA.ex&&(!bB2||e.bid>bB2.p))bB2={ex:e.ex,p:e.bid,sz:e.bidSz};if(e.ex!==bB.ex&&(!bA2||e.ask<bA2.p))bA2={ex:e.ex,p:e.ask,sz:e.askSz};});var c1=bB2?bB2.p-bA.p:-Infinity,c2=bA2?bB.p-bA2.p:-Infinity;if(c1>=c2&&bB2)bB=bB2;else if(bA2)bA=bA2;else return null;}
  var cross=bB.p-bA.p,rawPct=bA.p>0?(cross/bA.p)*100:0;
  var fee=FEE[mode]||0.001,net=cross-fee*2*bA.p,netPct=bA.p>0?(net/bA.p)*100:0;
  return{bB:bB,bA:bA,rawPct:rawPct,netPct:netPct,isProfit:netPct>0,exCount:ent.length};
}

/* ═══════════════ CONTROLS ═══════════════ */
function restart(){if(monitoring){wsStop();bbo={};setTimeout(function(){wsStart(watchPairs,mode,enabled);},200);}}
function doToggle(){if(monitoring){monitoring=false;wsStop();bbo={};cnt={};exStatus={};expanded=null;statusMsgs=[];fundingRates={};}else{bbo={};cnt={};exStatus={};expanded=null;statusMsgs=[];fundingRates={};monitoring=true;wsStart(watchPairs,mode,enabled);}renderAll();}
function setMode(m){mode=m;restart();renderAll();}
function setSort(k){sortKey=k;renderTable();}
function toggleEx(id){enabled[id]=!enabled[id];if(monitoring&&!enabled[id]&&sockets[id]){try{sockets[id].close();}catch(x){}delete sockets[id];}renderAll();}
function toggleWatch(p){var i=watchPairs.indexOf(p);if(i>=0)watchPairs.splice(i,1);else watchPairs.push(p);restart();renderAll();}

/* ═══════════════ RENDER ═══════════════ */
function renderAll(){renderBadges();renderMode();renderSort();renderChips();renderExBar();renderStatus();renderTable();renderFoot();}

function renderBadges(){
  var rate=0;Object.keys(cnt).forEach(function(k){rate+=cnt[k];});
  document.getElementById("badges").innerHTML='<span class="bg">● WS</span> <span class="by">⚡'+rate+'/s</span> <span class="bm">'+mode.toUpperCase()+'</span> <span class="bc">'+watchPairs.length+'P</span>';
  var btn=document.getElementById("startBtn");btn.textContent=monitoring?"■ Stop":"▶ Start";btn.className=monitoring?"mbtn stp":"mbtn go";
}
function renderMode(){var el=document.getElementById("modeGrp");el.innerHTML="";["spot","futures"].forEach(function(m){var b=document.createElement("button");b.className="tb"+(mode===m?" ta":"");b.textContent=m.charAt(0).toUpperCase()+m.slice(1);b.addEventListener("click",function(){setMode(m);});el.appendChild(b);});}
function renderSort(){var el=document.getElementById("sortGrp");el.innerHTML="";[["spread","乖離度"],["name","名前"],["exCount","#Ex"]].forEach(function(p){var b=document.createElement("button");b.className="tb"+(sortKey===p[0]?" ta":"");b.textContent=p[1];b.addEventListener("click",function(){setSort(p[0]);});el.appendChild(b);});}
function renderChips(){var el=document.getElementById("chipRow");el.innerHTML="";allPairs.forEach(function(p){var on=watchPairs.indexOf(p)>=0;var arb=bbo[p]?calcArb(bbo[p]):null;var hot=arb&&arb.isProfit;var b=document.createElement("button");b.className="chip"+(on?" on":"")+(hot?" hot":"");b.textContent=p;b.addEventListener("click",function(){toggleWatch(p);});el.appendChild(b);});}
function renderExBar(){var el=document.getElementById("exRow");el.innerHTML="";EX_IDS.forEach(function(id){var s=exStatus[id]||"idle";var sc=s==="active"?"#00ff88":(s==="connecting"||s==="reconnecting")?"#ffcc00":s==="error"?"#ff4444":"#2a2a3e";var div=document.createElement("div");div.className="exc"+(enabled[id]?"":" off");div.innerHTML='<span class="dot" style="background:'+sc+'"></span><span style="color:'+EX[id].c+'">'+EX[id].label+'</span>';div.addEventListener("click",function(){toggleEx(id);});el.appendChild(div);});}
function renderStatus(){var el=document.getElementById("statusBar");if(statusMsgs.length===0){el.style.display="none";return;}el.style.display="block";var h="";statusMsgs.slice(-5).forEach(function(m){h+='<div class="smsg '+m.lv+'">'+m.t+' '+m.msg+'</div>';});el.innerHTML=h;}
function renderFoot(){var n=0;EX_IDS.forEach(function(id){if(enabled[id])n++;});document.getElementById("footSt").textContent=monitoring?watchPairs.length+"P × "+n+"EX":"Ready";}

/* ── FR helpers ── */
function frColor(r){if(r==null||isNaN(r))return"fr-z";return r>0.01?"fr-p":r<-0.01?"fr-n":"fr-z";}
function frText(r){if(r==null||isNaN(r))return"—";return(r>0?"+":"")+r.toFixed(4)+"%";}
function frCountdown(ts){if(!ts||isNaN(ts))return"—";var d=ts-Date.now();if(d<=0)return"soon";var h=Math.floor(d/3600000),m=Math.floor((d%3600000)/60000);return h+"h"+String(m).padStart(2,"0")+"m";}

/* ── MAIN TABLE ── */
function renderTable(){
  var arr=watchPairs.map(function(p){return{pair:p,arb:bbo[p]?calcArb(bbo[p]):null,exN:Object.keys(bbo[p]||{}).length};});
  if(sortKey==="spread")arr.sort(function(a,b){return(b.arb?b.arb.rawPct:-999)-(a.arb?a.arb.rawPct:-999);});
  else if(sortKey==="name")arr.sort(function(a,b){return a.pair.localeCompare(b.pair);});
  else arr.sort(function(a,b){return b.exN-a.exN;});

  var tbody=document.getElementById("tbody");
  if(arr.length===0){tbody.innerHTML='<tr><td colspan="4" style="text-align:center;padding:40px;color:#333">'+(monitoring?"Connecting...":"ペアを選択して ▶ Start")+'</td></tr>';return;}

  var isFut=mode==="futures";
  var h="";
  arr.forEach(function(item){
    var pair=item.pair,arb=item.arb,isExp=expanded===pair,profit=arb&&arb.isProfit;
    var p=arb?prec(arb.bA.p):2;
    var pctColor=profit?"#00ff88":(arb&&arb.rawPct>0)?"#e8e800":"#555";
    var pct=arb?(arb.rawPct>0?"+":"")+arb.rawPct.toFixed(4)+"%":"—";

    var route='<span style="color:#333">—</span>';
    if(arb)route='<span style="color:'+EX[arb.bA.ex].c+';font-weight:600">'+EX[arb.bA.ex].label+'</span><span style="color:#444;margin:0 5px">→</span><span style="color:'+EX[arb.bB.ex].c+';font-weight:600">'+EX[arb.bB.ex].label+'</span>';

    var price='<span style="color:#333">—</span>';
    if(arb)price='<span style="color:#ff6b6b">'+arb.bA.p.toFixed(p)+'</span><span style="color:#333;margin:0 4px">&gt;</span><span style="color:#4ecdc4">'+arb.bB.p.toFixed(p)+'</span>';

    // ── main row ──
    h+='<tr class="mrow'+(isExp?' exp':'')+(profit?' profit':'')+'" data-pair="'+pair+'">'
      +'<td style="text-align:left"><span class="tk">'+pair+'</span><span class="tksub">/USDT</span><span class="arrow'+(isExp?' open':'')+'">▾</span></td>'
      +'<td style="text-align:left;font-size:12px">'+route+'</td>'
      +'<td style="text-align:right;font-size:13px;font-weight:500">'+price+'</td>'
      +'<td style="text-align:right;font-size:14px;font-weight:700;color:'+pctColor+'">'+pct+'</td></tr>';

    // ── dropdown detail row ──
    h+='<tr><td colspan="4" style="padding:0;border:none"><div class="dd-wrap'+(isExp?' open':'')+'">';
    if(isExp){
      var pb=bbo[pair]||{}, pFr=fundingRates[pair]||{};
      var activeN=EX_IDS.filter(function(id){return enabled[id]&&pb[id];}).length;
      var netInfo="";
      if(arb){var nc=arb.isProfit?"#00ff88":"#888";netInfo='<span style="color:'+nc+'">Net: '+(arb.netPct>0?"+":"")+arb.netPct.toFixed(4)+'% <span style="color:#444">(fee: '+(FEE[mode]*200).toFixed(2)+'%)</span></span>';}

      h+='<div class="dd-inner"><div class="dd-hdr"><span>'+pair+'/USDT — '+activeN+' active exchanges</span>'+netInfo+'</div>';
      h+='<table class="dt"><thead><tr>'
        +'<th style="text-align:left;width:110px">Exchange</th>'
        +'<th>Bid</th><th>BidSz</th><th>Ask</th><th>AskSz</th><th>Spread</th>';
      if(isFut)h+='<th style="width:80px">FR</th><th style="width:65px">Next</th>';
      h+='</tr></thead><tbody>';

      EX_IDS.forEach(function(id){
        if(!enabled[id])return;
        var d=pb[id], isBB=arb&&arb.bB.ex===id, isBA=arb&&arb.bA.ex===id;
        var pp=d?prec(d.bid):2;
        var spr=d?((d.ask-d.bid)/d.ask*100).toFixed(4)+"%":"—";
        var dotC=d?"#00ff88":"#333";
        var tags="";if(isBB)tags+='<span class="tag sell">SELL</span>';if(isBA)tags+='<span class="tag buy">BUY</span>';
        var exFr=pFr[id];

        h+='<tr class="dt-row">'
          +'<td style="text-align:left"><span class="dot" style="background:'+dotC+';width:5px;height:5px"></span> '
          +'<span style="color:'+EX[id].c+';font-weight:600">'+EX[id].label+'</span>'+tags+'</td>'
          +'<td style="color:'+(isBB?"#00ff88":"#bbb")+';font-weight:'+(isBB?700:400)+'">'+(d?d.bid.toFixed(pp):"—")+'</td>'
          +'<td style="color:#555">'+(d?fz(d.bidSz):"—")+'</td>'
          +'<td style="color:'+(isBA?"#ff6b6b":"#bbb")+';font-weight:'+(isBA?700:400)+'">'+(d?d.ask.toFixed(pp):"—")+'</td>'
          +'<td style="color:#555">'+(d?fz(d.askSz):"—")+'</td>'
          +'<td style="color:#666">'+spr+'</td>';

        if(isFut){
          if(exFr){
            h+='<td><span class="'+frColor(exFr.rate)+'">'+frText(exFr.rate)+'</span></td>';
            h+='<td style="color:#444;font-size:10px">'+frCountdown(exFr.nextTime)+'</td>';
          } else {
            h+='<td class="fr-z">—</td><td class="fr-z">—</td>';
          }
        }
        h+='</tr>';
      });
      h+='</tbody></table></div>';
    }
    h+='</div></td></tr>';
  });

  tbody.innerHTML=h;

  // set exact max-height for smooth animation
  var openEls=document.querySelectorAll('.dd-wrap.open');
  for(var i=0;i<openEls.length;i++){openEls[i].style.maxHeight=openEls[i].scrollHeight+"px";}
}

function renderCfg(){var el=document.getElementById("cfgList");el.innerHTML="";EX_IDS.forEach(function(id){var label=document.createElement("label");label.style.cssText="color:"+EX[id].c+";font-size:12px;display:flex;align-items:center;gap:5px;cursor:pointer";var cb=document.createElement("input");cb.type="checkbox";cb.checked=enabled[id];cb.style.accentColor=EX[id].c;cb.addEventListener("change",function(){toggleEx(id);renderCfg();});label.appendChild(cb);label.appendChild(document.createTextNode(EX[id].label));el.appendChild(label);});}

/* ═══════════════ EVENTS ═══════════════ */
document.getElementById("tbody").addEventListener("click",function(e){var tr=e.target.closest("tr.mrow");if(!tr)return;var pair=tr.getAttribute("data-pair");if(pair){expanded=expanded===pair?null:pair;renderTable();}});
document.getElementById("startBtn").addEventListener("click",doToggle);
document.getElementById("pairsBtn").addEventListener("click",function(){document.getElementById("editTa").value=allPairs.join("\n");document.getElementById("editOv").classList.add("show");});
document.getElementById("cfgBtn").addEventListener("click",function(){renderCfg();document.getElementById("cfgOv").classList.add("show");});
document.getElementById("allBtn").addEventListener("click",function(){watchPairs=allPairs.slice();restart();renderAll();});
document.getElementById("noneBtn").addEventListener("click",function(){watchPairs=[];if(monitoring){wsStop();bbo={};}renderAll();});
document.getElementById("editOv").addEventListener("click",function(e){if(e.target===this)this.classList.remove("show");});
document.getElementById("editCancelBtn").addEventListener("click",function(){document.getElementById("editOv").classList.remove("show");});
document.getElementById("editSaveBtn").addEventListener("click",function(){
  var lines=document.getElementById("editTa").value.split("\n"),np=[];
  lines.forEach(function(l){var s=l.trim().toUpperCase().replace(/\/.*|:.*/g,"");if(s&&/^[A-Z0-9]+$/.test(s)&&np.indexOf(s)<0)np.push(s);});
  if(np.length){allPairs=np;watchPairs=watchPairs.filter(function(p){return np.indexOf(p)>=0;});restart();}
  document.getElementById("editOv").classList.remove("show");renderAll();
});
document.getElementById("cfgOv").addEventListener("click",function(e){if(e.target===this)this.classList.remove("show");});
document.getElementById("cfgCloseBtn").addEventListener("click",function(){document.getElementById("cfgOv").classList.remove("show");});

/* ═══════════════ LOOPS ═══════════════ */
setInterval(function(){if(!monitoring)return;renderBadges();renderChips();renderExBar();renderStatus();renderTable();},100);
setInterval(function(){cnt={};},1000);
// FR refresh every 60s
setInterval(function(){if(monitoring&&mode==="futures"&&Date.now()-frLast>55000)fetchAllFR();},10000);

renderAll();
})();
</script>
</body>
</html>
