<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Arbitrage Scanner</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{background:#08080c;color:#ccc;font-family:'DM Mono','Consolas',monospace;display:flex;flex-direction:column;min-height:100vh}

/* header */
.hdr{background:#0a0a10;border-bottom:1px solid #111118;padding:10px 16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.title{margin:0;font-size:15px;font-weight:800;letter-spacing:1px;font-family:'Outfit',sans-serif;background:linear-gradient(90deg,#7ec8e3,#00ff88);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.badges{display:flex;align-items:center;flex-wrap:wrap;gap:2px}
.b{font-size:10px;font-weight:600;letter-spacing:.3px;margin-right:10px}
.b.g{color:#00ff88}.b.y{color:#e8e800}.b.m{color:#ff00ff}.b.c{color:#7ec8e3}
.b.glow{color:#00ff88;background:#0a1a0f;padding:1px 6px;border-radius:4px;border:1px solid #00ff8830;animation:pulse 1.5s infinite}

/* controls */
.ctrl{display:flex;align-items:center;gap:14px;padding:7px 16px;background:#090910;border-bottom:1px solid #111118;flex-wrap:wrap}
.lbl{color:#333;font-size:9px;font-weight:700;letter-spacing:1px;margin-right:4px}
.tg{display:inline-flex;border-radius:4px;overflow:hidden;border:1px solid #1a1a28}
.tb{padding:4px 12px;border:none;background:#0a0a12;color:#444;font-size:10px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .1s}
.tb:hover{color:#888}.tb.ta{background:#7ec8e3;color:#0a0a0f}

/* buttons */
.mbtn{padding:6px 18px;border:none;border-radius:5px;font-size:11px;font-weight:800;cursor:pointer;font-family:inherit;letter-spacing:.5px;transition:all .12s}
.mbtn.go{background:#00ff88;color:#0a0a0f}.mbtn.stop{background:#ff4444;color:#fff}
.mbtn:hover{filter:brightness(1.15)}
.sb{padding:4px 10px;border:1px solid #1a1a28;border-radius:4px;background:#0c0c14;color:#666;font-size:10px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .1s}
.sb:hover{border-color:#333;color:#999}
.csb{padding:2px 7px;border:1px solid #1a1a28;border-radius:3px;font-size:9px;font-weight:700;cursor:pointer;font-family:inherit;background:#0a0a12;color:#444}
.csb:hover{color:#888}

/* chips */
.chip-row{display:flex;gap:4px;padding:6px 16px;background:#090910;border-bottom:1px solid #111118;overflow-x:auto;flex-wrap:wrap}
.chip{padding:2px 8px;border:1px solid #151520;border-radius:12px;font-size:10px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .1s;background:#08080c;color:#2a2a3e}
.chip:hover{border-color:#333}.chip.on{background:#111118;border-color:#222;color:#bbb}
.chip.hot{border-color:#00ff8830;color:#00ff88;background:#0a140f}

/* exchange bar */
.ex-row{display:flex;gap:4px;padding:6px 16px;background:#08080c;border-bottom:1px solid #111118;flex-wrap:wrap}
.exc{display:inline-flex;align-items:center;gap:5px;padding:4px 8px;border:1px solid #111118;border-radius:4px;cursor:pointer;transition:all .1s;font-size:10px}
.exc:hover{border-color:#222}.exc.off{opacity:.25}
.dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}

/* table */
.table-area{flex:1;overflow-y:auto}
.mt{width:100%;border-collapse:collapse}
.mt thead th{padding:8px 12px;font-size:10px;font-weight:700;color:#444;text-transform:uppercase;letter-spacing:.8px;border-bottom:1px solid #151520;background:#0a0a10;position:sticky;top:0;z-index:2}
.mrow{cursor:pointer;transition:background .08s;border-bottom:1px solid #0c0c14}
.mrow:hover{background:#0e0e18}
.mrow.exp{background:#0c0c16}
.mrow.profit{background:#080f0c}
.mrow.profit:hover{background:#0a140f}
.mrow td{padding:10px 12px;font-size:13px;font-variant-numeric:tabular-nums}
.tk{font-weight:800;color:#7ec8e3;font-size:15px;font-family:'Outfit',sans-serif}
.tksub{color:#2a2a3e;font-size:11px;margin-left:3px}

/* detail */
.detail{animation:fadeIn .25s ease}
.detail-inner{background:#090910;border-top:1px solid #151520;border-bottom:1px solid #151520}
.detail-hdr{display:flex;justify-content:space-between;align-items:center;padding:8px 16px;font-size:11px;color:#555;border-bottom:1px solid #0f0f18;flex-wrap:wrap;gap:8px}
.dt{width:100%;border-collapse:collapse}
.dt th{padding:5px 10px;text-align:right;font-size:9px;font-weight:700;color:#333;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid #0f0f18;background:#080810}
.dt td{padding:5px 10px;text-align:right;font-size:12px;font-variant-numeric:tabular-nums}
.dt-row{border-bottom:1px solid #0a0a12;transition:background .08s}
.dt-row:hover{background:#0d0d18}
.tag{font-size:8px;font-weight:800;padding:1px 5px;border-radius:3px;letter-spacing:.5px;margin-left:4px;display:inline-block}
.tag.buy{background:#ff6b6b22;color:#ff6b6b;border:1px solid #ff6b6b33}
.tag.sell{background:#00ff8822;color:#00ff88;border:1px solid #00ff8833}

/* log */
.log-bar{padding:4px 12px;display:flex;justify-content:flex-end}
.log-box{margin:0 12px 8px;background:#08080c;border:1px solid #111118;border-radius:6px;max-height:140px;overflow-y:auto;padding:6px 10px;display:none}
.log-box.show{display:block}
.log-line{font-size:10px;line-height:1.5;white-space:nowrap}
.log-line.ok{color:#00ff88}.log-line.warn{color:#e8e800}.log-line.error{color:#ff4444}

/* overlay */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000;display:none}
.ov.show{display:flex}
.modal{background:#0c0c18;border:1px solid #1a1a28;border-radius:10px;padding:20px;min-width:300px;max-width:460px;max-height:85vh;overflow-y:auto}
.m-ta{width:100%;background:#07070c;color:#bbb;border:1px solid #1a1a28;border-radius:5px;padding:10px;font-family:inherit;font-size:12px;resize:vertical;outline:none}

.footer{display:flex;justify-content:space-between;padding:5px 16px;background:#0a0a10;border-top:1px solid #111118;font-size:9px;color:#1a1a28}

@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:#08080c}
::-webkit-scrollbar-thumb{background:#1a1a28;border-radius:3px}
</style>
</head>
<body>

<header class="hdr">
  <div style="display:flex;align-items:center;gap:12px;flex:1;flex-wrap:wrap">
    <h1 class="title">‚óÜ Arbitrage Scanner</h1>
    <div class="badges" id="badges"></div>
  </div>
  <div style="display:flex;gap:6px;flex-shrink:0">
    <button class="mbtn go" id="startBtn" onclick="toggle()">‚ñ∂ Start</button>
    <button class="sb" onclick="openEdit()">Pairs</button>
    <button class="sb" onclick="openCfg()">‚öô</button>
  </div>
</header>

<div class="ctrl">
  <div style="display:flex;align-items:center;gap:6px">
    <span class="lbl">MODE</span>
    <div class="tg" id="modeGrp"></div>
  </div>
  <div style="display:flex;align-items:center;gap:6px">
    <span class="lbl">SORT</span>
    <div class="tg" id="sortGrp"></div>
  </div>
  <div style="display:flex;align-items:center;gap:4px;margin-left:auto">
    <button class="csb" onclick="selAll()">All</button>
    <button class="csb" onclick="selNone()">None</button>
  </div>
</div>

<div class="chip-row" id="chipRow"></div>
<div class="ex-row" id="exRow"></div>

<div class="table-area">
  <table class="mt">
    <thead>
      <tr>
        <th style="text-align:left;width:80px">Ticker</th>
        <th style="text-align:left">best„É´„Éº„Éà</th>
        <th style="text-align:right;width:260px">ÂÄ§ÊÆµ</th>
        <th style="text-align:right;width:110px">‰πñÈõ¢Â∫¶</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div class="log-bar">
  <button class="sb" style="font-size:10px;padding:3px 8px" onclick="toggleLog()" id="logBtn">Log (0)</button>
</div>
<div class="log-box" id="logBox"></div>

<!-- Pair Editor Modal -->
<div class="ov" id="editOv" onclick="closeEdit()">
  <div class="modal" onclick="event.stopPropagation()">
    <h3 style="color:#7ec8e3;margin:0 0 12px">„Éö„Ç¢„É™„Çπ„ÉàÁ∑®ÈõÜ</h3>
    <p style="color:#555;font-size:11px;margin-bottom:8px">1Ë°å„Å´1„ÉÜ„Ç£„ÉÉ„Ç´„ÉºÔºà‰æã: BTCÔºâ</p>
    <textarea id="editTa" class="m-ta" rows="16"></textarea>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="mbtn go" onclick="saveEdit()">‰øùÂ≠ò</button>
      <button class="sb" onclick="closeEdit()">„Ç≠„É£„É≥„Çª„É´</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="ov" id="cfgOv" onclick="closeCfg()">
  <div class="modal" onclick="event.stopPropagation()">
    <h3 style="color:#7ec8e3;margin:0 0 16px">Ë®≠ÂÆö</h3>
    <h4 style="color:#555;font-size:11px;margin-bottom:8px">ÂèñÂºïÊâÄ ON/OFF</h4>
    <div id="cfgList" style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:16px"></div>
    <button class="sb" onclick="closeCfg()" style="margin-top:8px">Èñâ„Åò„Çã</button>
  </div>
</div>

<footer class="footer">
  <span>Multi-Pair BBO Arbitrage Scanner v3</span>
  <span id="footSt">Ready</span>
</footer>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const EX={
  binance:{label:"Binance",c:"#F0B90B"},okx:{label:"OKX",c:"#FFFFFF"},
  bybit:{label:"Bybit",c:"#F7A600"},bitget:{label:"Bitget",c:"#00E0AA"},
  mexc:{label:"MEXC",c:"#2EBD85"},gate:{label:"Gate",c:"#2354E6"},
  hyperliquid:{label:"Hyperliquid",c:"#82FFB5"},aster:{label:"Aster",c:"#FF6B6B"},
};
const EX_IDS=Object.keys(EX);
const FEE={futures:0.0007,spot:0.001};

let allPairs=["BTC","ETH","SOL","BNB","XRP","DOGE","ADA","AVAX","LINK","ARB","NEAR","OP","APT","SUI","PEPE","WIF","TIA","INJ","SEI","FET"];
let watchPairs=allPairs.slice(0,10);
let enabled=Object.fromEntries(EX_IDS.map(k=>[k,true]));
let mode="futures";
let sortKey="spread";
let monitoring=false;
let bbo={};       // {pair:{exId:{bid,ask,bidSz,askSz,mid,ts}}}
let statuses={};  // {exId:"active"|"connecting"|...}
let logs=[];
let cnt={};       // rate counters
let expanded=null;
let showLogPanel=false;

const prec=p=>p>=10000?2:p>=100?4:p>=1?5:8;
const fp=(n,p)=>{if(n==null||isNaN(n))return"‚Äî";return n.toFixed(p!=null?p:prec(n))};
const fz=n=>{if(!n||isNaN(n))return"‚Äî";return n>=1000?n.toFixed(1):n.toFixed(4)};
const ts=()=>{const d=new Date();return d.toLocaleTimeString("en-GB",{hour12:false})+"."+String(d.getMilliseconds()).padStart(3,"0")};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   WebSocket Manager
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const ws={}, timers={}, pings={};
let wsActive=false, wsPairs=[], wsMode="futures", wsEn={};

function wsStart(pairs,m,en){
  wsStop();wsActive=true;wsPairs=pairs.map(p=>p.toUpperCase());wsMode=m;wsEn={...en};
  EX_IDS.forEach(id=>{if(en[id])wsConn(id);});
}
function wsStop(){
  wsActive=false;
  Object.values(ws).forEach(w=>{try{w.close()}catch(e){}});
  for(const k in ws)delete ws[k];
  Object.values(timers).forEach(clearTimeout);for(const k in timers)delete timers[k];
  Object.values(pings).forEach(clearInterval);for(const k in pings)delete pings[k];
}
function wsRetry(id,ms){
  if(!wsActive||!wsEn[id])return;
  timers[id]=setTimeout(()=>{if(wsActive&&wsEn[id])wsConn(id);},ms||3000);
}
function wsClosed(id){
  if(pings[id]){clearInterval(pings[id]);delete pings[id];}
  if(wsActive&&wsEn[id]){statuses[id]="reconnecting";wsRetry(id);}
}
function onBBO(exId,pair,d){
  const p=pair.toUpperCase();
  if(!bbo[p])bbo[p]={};
  bbo[p][exId]={...d,mid:(d.bid+d.ask)/2,ts:Date.now()};
  cnt[p+":"+exId]=(cnt[p+":"+exId]||0)+1;
}
function addLog(msg,lv){logs.push({ts:ts(),msg,lv:lv||"info"});if(logs.length>150)logs=logs.slice(-100);}

function wsConn(id){
  statuses[id]="connecting";
  try{window["ws_"+id]();}catch(e){addLog(EX[id].label+": "+e.message,"error");statuses[id]="error";}
}

/* ‚îÄ‚îÄ Binance ‚îÄ‚îÄ */
window.ws_binance=function(){
  const ss=wsPairs.map(p=>p.toLowerCase()+"usdt@bookTicker").join("/");
  const h=wsMode==="futures"?"wss://fstream.binance.com":"wss://stream.binance.com:9443";
  const w=new WebSocket(h+"/stream?streams="+ss);ws.binance=w;
  w.onopen=()=>{statuses.binance="active";addLog("Binance: "+wsPairs.length+" pairs","ok");};
  w.onmessage=e=>{try{const m=JSON.parse(e.data),d=m.data||m,p=(d.s||"").replace(/USDT$/i,"");if(p){const b=+d.b,a=+d.a;if(b>0&&a>0)onBBO("binance",p,{bid:b,ask:a,bidSz:+d.B||0,askSz:+d.A||0});}}catch(x){}};
  w.onerror=()=>{statuses.binance="error"};w.onclose=()=>wsClosed("binance");
};

/* ‚îÄ‚îÄ Bybit ‚îÄ‚îÄ */
window.ws_bybit=function(){
  const url=wsMode==="futures"?"wss://stream.bybit.com/v5/public/linear":"wss://stream.bybit.com/v5/public/spot";
  const w=new WebSocket(url);ws.bybit=w;
  w.onopen=()=>{w.send(JSON.stringify({op:"subscribe",args:wsPairs.map(p=>"tickers."+p+"USDT")}));statuses.bybit="active";addLog("Bybit: "+wsPairs.length+" pairs","ok");pings.bybit=setInterval(()=>{try{w.send(JSON.stringify({op:"ping"}))}catch(x){}},20000);};
  w.onmessage=e=>{try{const m=JSON.parse(e.data);if(!m.topic||!m.data)return;const p=m.topic.replace("tickers.","").replace(/USDT$/i,""),d=m.data,b=+d.bid1Price,a=+d.ask1Price;if(b>0&&a>0)onBBO("bybit",p,{bid:b,ask:a,bidSz:+d.bid1Size||0,askSz:+d.ask1Size||0});}catch(x){}};
  w.onerror=()=>{statuses.bybit="error"};w.onclose=()=>wsClosed("bybit");
};

/* ‚îÄ‚îÄ OKX ‚îÄ‚îÄ */
window.ws_okx=function(){
  const w=new WebSocket("wss://ws.okx.com:8443/ws/v5/public");ws.okx=w;
  w.onopen=()=>{const sfx=wsMode==="futures"?"-USDT-SWAP":"-USDT";w.send(JSON.stringify({op:"subscribe",args:wsPairs.map(p=>({channel:"bbo-tbt",instId:p+sfx}))}));statuses.okx="active";addLog("OKX: "+wsPairs.length+" pairs","ok");};
  w.onmessage=e=>{try{const m=JSON.parse(e.data);if(!m.data||!m.arg)return;const p=(m.arg.instId||"").split("-")[0],d=m.data[0],b=+d.bidPx,a=+d.askPx;if(b>0&&a>0)onBBO("okx",p,{bid:b,ask:a,bidSz:+d.bidSz||0,askSz:+d.askSz||0});}catch(x){}};
  w.onerror=()=>{statuses.okx="error"};w.onclose=()=>wsClosed("okx");
};

/* ‚îÄ‚îÄ Bitget ‚îÄ‚îÄ */
window.ws_bitget=function(){
  const w=new WebSocket("wss://ws.bitget.com/v2/ws/public");ws.bitget=w;
  w.onopen=()=>{const t=wsMode==="futures"?"USDT-FUTURES":"SPOT";w.send(JSON.stringify({op:"subscribe",args:wsPairs.map(p=>({instType:t,channel:"ticker",instId:p+"USDT"}))}));statuses.bitget="active";addLog("Bitget: "+wsPairs.length+" pairs","ok");pings.bitget=setInterval(()=>{try{w.send("ping")}catch(x){}},25000);};
  w.onmessage=e=>{try{if(e.data==="pong")return;const m=JSON.parse(e.data);if(!m.data||!Array.isArray(m.data))return;const d=m.data[0];if(!d)return;const sym=d.instId||"",p=sym.replace(/USDT$/i,""),b=+(d.bidPr||d.bestBid||0),a=+(d.askPr||d.bestAsk||0);if(b>0&&a>0)onBBO("bitget",p,{bid:b,ask:a,bidSz:+(d.bidSz||0),askSz:+(d.askSz||0)});}catch(x){}};
  w.onerror=()=>{statuses.bitget="error"};w.onclose=()=>wsClosed("bitget");
};

/* ‚îÄ‚îÄ MEXC ‚îÄ‚îÄ */
window.ws_mexc=function(){
  const url=wsMode==="futures"?"wss://contract.mexc.com/edge":"wss://wbs.mexc.com/ws";
  const w=new WebSocket(url);ws.mexc=w;
  w.onopen=()=>{if(wsMode==="futures"){wsPairs.forEach(p=>w.send(JSON.stringify({method:"sub.ticker",param:{symbol:p+"USDT"}})));}else{w.send(JSON.stringify({method:"SUBSCRIPTION",params:wsPairs.map(p=>"spot@public.bookTicker.v3.api@"+p+"USDT")}));}statuses.mexc="active";addLog("MEXC: "+wsPairs.length+" pairs","ok");pings.mexc=setInterval(()=>{try{w.send(wsMode==="futures"?JSON.stringify({method:"ping"}):"ping")}catch(x){}},20000);};
  w.onmessage=e=>{try{const m=JSON.parse(e.data);if(wsMode==="spot"){const p=(m.s||"").replace(/USDT$/i,""),d=m.d||m,b=+(d.b||d.bidPrice||0),a=+(d.a||d.askPrice||0);if(b>0&&a>0&&p)onBBO("mexc",p,{bid:b,ask:a,bidSz:+(d.B||0),askSz:+(d.A||0)});}else if(m.data){const d=m.data,p=(d.symbol||"").replace(/_?USDT$/i,""),b=+(d.bid1||0),a=+(d.ask1||0);if(b>0&&a>0&&p)onBBO("mexc",p,{bid:b,ask:a,bidSz:0,askSz:0});}}catch(x){}};
  w.onerror=()=>{statuses.mexc="error"};w.onclose=()=>wsClosed("mexc");
};

/* ‚îÄ‚îÄ Gate ‚îÄ‚îÄ */
window.ws_gate=function(){
  const url=wsMode==="futures"?"wss://fx-ws.gateio.ws/v4/ws/usdt":"wss://api.gateio.ws/ws/v4/";
  const w=new WebSocket(url);ws.gate=w;
  w.onopen=()=>{const ch=wsMode==="futures"?"futures.book_ticker":"spot.book_ticker";w.send(JSON.stringify({time:Math.floor(Date.now()/1000),channel:ch,event:"subscribe",payload:wsPairs.map(p=>p+"_USDT")}));statuses.gate="active";addLog("Gate: "+wsPairs.length+" pairs","ok");};
  w.onmessage=e=>{try{const m=JSON.parse(e.data),d=m.result;if(!d)return;const p=(d.s||d.contract||"").replace(/_?USDT$/i,"").toUpperCase(),b=+(d.b||d.best_bid||0),a=+(d.a||d.best_ask||0);if(b>0&&a>0&&p)onBBO("gate",p,{bid:b,ask:a,bidSz:+(d.B||d.best_bid_amount||0),askSz:+(d.A||d.best_ask_amount||0)});}catch(x){}};
  w.onerror=()=>{statuses.gate="error"};w.onclose=()=>wsClosed("gate");
};

/* ‚îÄ‚îÄ Hyperliquid ‚îÄ‚îÄ */
window.ws_hyperliquid=function(){
  const w=new WebSocket("wss://api.hyperliquid.xyz/ws");ws.hyperliquid=w;
  w.onopen=()=>{wsPairs.forEach(p=>w.send(JSON.stringify({method:"subscribe",subscription:{type:"l2Book",coin:p}})));statuses.hyperliquid="active";addLog("Hyperliquid: "+wsPairs.length+" pairs","ok");};
  w.onmessage=e=>{try{const m=JSON.parse(e.data);if(m.channel!=="l2Book"||!m.data||!m.data.levels)return;const p=(m.data.coin||"").toUpperCase(),bids=m.data.levels[0]||[],asks=m.data.levels[1]||[];if(bids.length&&asks.length){const b=+bids[0].px,a=+asks[0].px;if(b>0&&a>0)onBBO("hyperliquid",p,{bid:b,ask:a,bidSz:+bids[0].sz||0,askSz:+asks[0].sz||0});}}catch(x){}};
  w.onerror=()=>{statuses.hyperliquid="error"};w.onclose=()=>wsClosed("hyperliquid");
};

/* ‚îÄ‚îÄ Aster ‚îÄ‚îÄ */
window.ws_aster=function(){
  const ss=wsPairs.map(p=>p.toLowerCase()+"usdt@bookTicker").join("/");
  const h=wsMode==="futures"?"wss://fstream.asterdex.com":"wss://sstream.asterdex.com";
  const w=new WebSocket(h+"/stream?streams="+ss);ws.aster=w;
  w.onopen=()=>{statuses.aster="active";addLog("Aster: "+wsPairs.length+" pairs","ok");};
  w.onmessage=e=>{try{const pl=JSON.parse(e.data),d=pl.data||pl,p=(d.s||"").replace(/USDT$/i,"").toUpperCase(),b=+(d.b||d.bidPrice||0),a=+(d.a||d.askPrice||0);if(b>0&&a>0&&p)onBBO("aster",p,{bid:b,ask:a,bidSz:+(d.B||0),askSz:+(d.A||0)});}catch(x){}};
  w.onerror=()=>{statuses.aster="error"};w.onclose=()=>wsClosed("aster");
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Arb Calc
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function calcArb(pb){
  const ent=Object.entries(pb).filter(([,d])=>d&&d.bid>0&&d.ask>0);
  if(ent.length<2)return null;
  let bB=null,bA=null;
  ent.forEach(([ex,d])=>{
    if(!bB||d.bid>bB.p)bB={ex,p:d.bid,sz:d.bidSz};
    if(!bA||d.ask<bA.p)bA={ex,p:d.ask,sz:d.askSz};
  });
  if(bB.ex===bA.ex){
    let bB2=null,bA2=null;
    ent.forEach(([ex,d])=>{
      if(ex!==bA.ex&&(!bB2||d.bid>bB2.p))bB2={ex,p:d.bid,sz:d.bidSz};
      if(ex!==bB.ex&&(!bA2||d.ask<bA2.p))bA2={ex,p:d.ask,sz:d.askSz};
    });
    const c1=bB2?bB2.p-bA.p:-Infinity,c2=bA2?bB.p-bA2.p:-Infinity;
    if(c1>=c2&&bB2)bB=bB2;else if(bA2)bA=bA2;else return null;
  }
  const cross=bB.p-bA.p,rawPct=bA.p>0?(cross/bA.p)*100:0;
  const fee=FEE[mode]||0.001,net=cross-fee*2*bA.p,netPct=bA.p>0?(net/bA.p)*100:0;
  return{bB,bA,cross,rawPct,netPct,isProfit:netPct>0,exCount:ent.length};
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Controls
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toggle(){
  if(monitoring){monitoring=false;wsStop();bbo={};cnt={};statuses={};expanded=null;}
  else{bbo={};cnt={};logs=[];statuses={};expanded=null;monitoring=true;wsStart(watchPairs,mode,enabled);}
  renderAll();
}
function setMode(m){mode=m;if(monitoring){wsStop();bbo={};setTimeout(()=>wsStart(watchPairs,mode,enabled),200);}renderAll();}
function setSort(k){sortKey=k;renderAll();}
function toggleEx(id){enabled[id]=!enabled[id];if(monitoring&&!enabled[id]&&ws[id]){try{ws[id].close()}catch(x){}delete ws[id];}renderAll();}
function toggleWatch(p){const i=watchPairs.indexOf(p);if(i>=0)watchPairs.splice(i,1);else watchPairs.push(p);if(monitoring){wsStop();bbo={};setTimeout(()=>wsStart(watchPairs,mode,enabled),200);}renderAll();}
function selAll(){watchPairs=[...allPairs];if(monitoring){wsStop();bbo={};setTimeout(()=>wsStart(watchPairs,mode,enabled),200);}renderAll();}
function selNone(){watchPairs=[];if(monitoring){wsStop();bbo={};}renderAll();}
function toggleExpanded(p){expanded=expanded===p?null:p;renderTable();}
function toggleLog(){showLogPanel=!showLogPanel;renderLog();}

/* Pair editor */
function openEdit(){document.getElementById("editTa").value=allPairs.join("\n");document.getElementById("editOv").classList.add("show");}
function closeEdit(){document.getElementById("editOv").classList.remove("show");}
function saveEdit(){
  const np=document.getElementById("editTa").value.split("\n").map(l=>l.trim().toUpperCase().replace(/\/.*|:.*/g,"")).filter(s=>s&&/^[A-Z0-9]+$/.test(s));
  if(np.length){allPairs=[...new Set(np)];watchPairs=watchPairs.filter(p=>allPairs.includes(p));if(monitoring){wsStop();bbo={};setTimeout(()=>wsStart(watchPairs,mode,enabled),200);}}
  closeEdit();renderAll();
}
/* Config */
function openCfg(){renderCfg();document.getElementById("cfgOv").classList.add("show");}
function closeCfg(){document.getElementById("cfgOv").classList.remove("show");}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RENDER
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderAll(){renderBadges();renderMode();renderSort();renderChips();renderExBar();renderTable();renderLog();renderFoot();}

function renderBadges(){
  const rate=Object.values(cnt).reduce((s,v)=>s+v,0);
  const profitN=watchPairs.filter(p=>bbo[p]&&calcArb(bbo[p])&&calcArb(bbo[p]).isProfit).length;
  let h='<span class="b g">‚óè WS</span><span class="b y">‚ö°'+rate+'/s</span><span class="b m">'+mode.toUpperCase()+'</span><span class="b c">'+watchPairs.length+'P</span>';
  if(profitN>0)h+='<span class="b glow">üî•'+profitN+'</span>';
  document.getElementById("badges").innerHTML=h;
  const btn=document.getElementById("startBtn");
  btn.textContent=monitoring?"‚ñ† Stop":"‚ñ∂ Start";
  btn.className=monitoring?"mbtn stop":"mbtn go";
}

function renderMode(){
  let h="";
  ["spot","futures"].forEach(m=>{h+='<button class="tb'+(mode===m?' ta':'')+'" onclick="setMode(\''+m+'\')">'+m[0].toUpperCase()+m.slice(1)+'</button>';});
  document.getElementById("modeGrp").innerHTML=h;
}

function renderSort(){
  let h="";
  [["spread","‰πñÈõ¢Â∫¶"],["name","ÂêçÂâç"],["exCount","ÂèñÂºïÊâÄÊï∞"]].forEach(([k,l])=>{h+='<button class="tb'+(sortKey===k?' ta':'')+'" onclick="setSort(\''+k+'\')">'+l+'</button>';});
  document.getElementById("sortGrp").innerHTML=h;
}

function renderChips(){
  let h="";
  allPairs.forEach(p=>{
    const on=watchPairs.includes(p);
    const arb=bbo[p]?calcArb(bbo[p]):null;
    const hot=arb&&arb.isProfit;
    h+='<button class="chip'+(on?' on':'')+(hot?' hot':'')+'" onclick="toggleWatch(\''+p+'\')">'+p+'</button>';
  });
  document.getElementById("chipRow").innerHTML=h;
}

function renderExBar(){
  let h="";
  EX_IDS.forEach(id=>{
    const s=statuses[id]||"idle";
    const sc=s==="active"?"#00ff88":s==="connecting"||s==="reconnecting"?"#ffcc00":s==="error"?"#ff4444":"#2a2a3e";
    const anim=s==="connecting"||s==="reconnecting"?"animation:pulse 1s infinite;":"";
    h+='<div class="exc'+(enabled[id]?'':' off')+'" onclick="toggleEx(\''+id+'\')">'
      +'<div class="dot" style="background:'+sc+';'+anim+'"></div>'
      +'<span style="color:'+EX[id].c+';font-weight:700">'+EX[id].label+'</span></div>';
  });
  document.getElementById("exRow").innerHTML=h;
}

function renderTable(){
  const arr=watchPairs.map(p=>({pair:p,arb:bbo[p]?calcArb(bbo[p]):null,exN:Object.keys(bbo[p]||{}).length}));
  if(sortKey==="spread")arr.sort((a,b)=>(b.arb?b.arb.rawPct:-999)-(a.arb?a.arb.rawPct:-999));
  else if(sortKey==="name")arr.sort((a,b)=>a.pair.localeCompare(b.pair));
  else arr.sort((a,b)=>b.exN-a.exN);

  if(arr.length===0){
    document.getElementById("tbody").innerHTML='<tr><td colspan="4" style="text-align:center;padding:40px;color:#333">'+(monitoring?"Connecting...":"„Éö„Ç¢„ÇíÈÅ∏Êäû„Åó„Å¶ ‚ñ∂ Start")+'</td></tr>';
    return;
  }

  let h="";
  arr.forEach(({pair,arb})=>{
    const isExp=expanded===pair;
    const profit=arb&&arb.isProfit;
    const p=arb?prec(arb.bA.p):2;
    const pctColor=profit?"#00ff88":arb&&arb.rawPct>0?"#e8e800":"#555";
    const pct=arb?(arb.rawPct>0?"+":"")+arb.rawPct.toFixed(4)+"%":"‚Äî";

    // Route display
    let routeHtml="<span style='color:#333'>‚Äî</span>";
    if(arb){
      routeHtml="<span style='color:"+EX[arb.bA.ex].c+";font-weight:600'>"+EX[arb.bA.ex].label+"</span>"
        +"<span style='color:#444;margin:0 5px'>‚Üí</span>"
        +"<span style='color:"+EX[arb.bB.ex].c+";font-weight:600'>"+EX[arb.bB.ex].label+"</span>";
    }

    // Price display
    let priceHtml="<span style='color:#333'>‚Äî</span>";
    if(arb){
      priceHtml="<span style='color:#ff6b6b'>"+arb.bA.p.toFixed(p)+"</span>"
        +"<span style='color:#333;margin:0 4px'>&gt;</span>"
        +"<span style='color:#4ecdc4'>"+arb.bB.p.toFixed(p)+"</span>";
    }

    h+='<tr class="mrow'+(isExp?' exp':'')+(profit?' profit':'')+'" onclick="toggleExpanded(\''+pair+'\')">'
      +'<td style="text-align:left"><span class="tk">'+pair+'</span><span class="tksub">/USDT</span></td>'
      +'<td style="text-align:left;font-size:12px">'+routeHtml+'</td>'
      +'<td style="text-align:right;font-size:13px;font-weight:500;letter-spacing:.3px">'+priceHtml+'</td>'
      +'<td style="text-align:right;font-size:14px;font-weight:700;font-family:Outfit,sans-serif;color:'+pctColor+'">'+pct+'</td>'
      +'</tr>';

    // Expanded detail
    if(isExp){
      const pb=bbo[pair]||{};
      const activeN=EX_IDS.filter(id=>enabled[id]&&pb[id]).length;
      let netInfo="";
      if(arb){
        const netC=arb.isProfit?"#00ff88":"#888";
        netInfo='<span style="color:'+netC+'">Net: '+(arb.netPct>0?"+":"")+arb.netPct.toFixed(4)+'%'
          +'<span style="color:#444;margin-left:8px">(fee: '+(FEE[mode]*200).toFixed(2)+'%)</span></span>';
      }
      h+='<tr class="detail"><td colspan="4" style="padding:0"><div class="detail-inner">'
        +'<div class="detail-hdr"><span>'+pair+'/USDT ‚Äî '+activeN+' exchanges</span>'+netInfo+'</div>'
        +'<table class="dt"><thead><tr>'
        +'<th style="text-align:left;width:120px">Exchange</th><th>Bid</th><th>Bid Size</th><th>Ask</th><th>Ask Size</th><th>Mid Price</th><th>Spread</th>'
        +'</tr></thead><tbody>';

      EX_IDS.filter(id=>enabled[id]).forEach(id=>{
        const d=pb[id];
        const isBB=arb&&arb.bB.ex===id;
        const isBA=arb&&arb.bA.ex===id;
        const pp=d?prec(d.bid):2;
        const spr=d?((d.ask-d.bid)/d.ask*100).toFixed(4)+"%":"‚Äî";
        const dotC=d?"#00ff88":"#333";
        let tags="";
        if(isBB)tags+='<span class="tag sell">SELL</span>';
        if(isBA)tags+='<span class="tag buy">BUY</span>';

        h+='<tr class="dt-row">'
          +'<td style="text-align:left"><span style="display:inline-flex;align-items:center;gap:6px">'
          +'<span class="dot" style="background:'+dotC+';width:5px;height:5px"></span>'
          +'<span style="color:'+EX[id].c+';font-weight:600">'+EX[id].label+'</span>'+tags+'</span></td>'
          +'<td style="color:'+(isBB?"#00ff88":"#bbb")+';font-weight:'+(isBB?700:400)+'">'+(d?d.bid.toFixed(pp):"‚Äî")+'</td>'
          +'<td style="color:#555">'+(d?fz(d.bidSz):"‚Äî")+'</td>'
          +'<td style="color:'+(isBA?"#ff6b6b":"#bbb")+';font-weight:'+(isBA?700:400)+'">'+(d?d.ask.toFixed(pp):"‚Äî")+'</td>'
          +'<td style="color:#555">'+(d?fz(d.askSz):"‚Äî")+'</td>'
          +'<td style="color:#7ec8e3">'+(d?d.mid.toFixed(pp):"‚Äî")+'</td>'
          +'<td style="color:#666">'+spr+'</td></tr>';
      });

      h+='</tbody></table></div></td></tr>';
    }
  });

  document.getElementById("tbody").innerHTML=h;
}

function renderLog(){
  document.getElementById("logBtn").textContent=(showLogPanel?"Hide Log":"Log")+" ("+logs.length+")";
  const box=document.getElementById("logBox");
  box.className=showLogPanel?"log-box show":"log-box";
  if(showLogPanel){
    let h="";
    logs.slice(-30).reverse().forEach(l=>{
      h+='<div class="log-line '+(l.lv||"")+'"><span style="color:#2a2a3e">['+l.ts+']</span> '+l.msg+'</div>';
    });
    box.innerHTML=h;
  }
}

function renderCfg(){
  let h="";
  EX_IDS.forEach(id=>{
    h+='<label style="color:'+EX[id].c+';font-size:12px;display:flex;align-items:center;gap:5px;cursor:pointer">'
      +'<input type="checkbox" '+(enabled[id]?'checked':'')+' onchange="toggleEx(\''+id+'\');renderCfg()" style="accent-color:'+EX[id].c+'"/>'
      +EX[id].label+'</label>';
  });
  document.getElementById("cfgList").innerHTML=h;
}

function renderFoot(){
  document.getElementById("footSt").textContent=monitoring?watchPairs.length+"P √ó "+Object.values(enabled).filter(Boolean).length+"EX":"Ready";
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Main loop ‚Äî 10fps UI refresh
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
setInterval(()=>{
  if(!monitoring)return;
  renderBadges();renderChips();renderExBar();renderTable();renderLog();
},100);

// Reset rate counters 1/s
setInterval(()=>{cnt={};},1000);

// Initial render
renderAll();
</script>
</body>
</html>
